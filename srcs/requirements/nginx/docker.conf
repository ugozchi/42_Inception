# --- HTTP to HTTPS redirection server block ---
server {
    listen      80;                     # Listen on port 80 for IPv4 (HTTP)
    listen      [::]:80;                # Listen on port 80 for IPv6 (HTTP)
    server_name ${SERVER_NAME:?error};  # Use the domain name from environment variable

    # Redirect all HTTP requests to HTTPS
    return 301 https://$server_name$request_uri;
}

# --- Main HTTPS server block ---
server {
    listen      443 ssl http2;           # Listen on port 443 (HTTPS) with HTTP/2 support (IPv4)
    listen      [::]:443 ssl http2;      # Same for IPv6

    server_name ${SERVER_NAME:?error};   # Use the domain name from environment variable

    # --- SSL/TLS certificate configuration ---
    ssl_certificate         /etc/ssl/certs/nginx.crt;         # Path to SSL certificate
    ssl_certificate_key     /etc/ssl/private/nginx.key;       # Path to SSL certificate key
    ssl_protocols           TLSv1.2 TLSv1.3;                  # Only allow secure protocols
    ssl_ciphers             HIGH:!aNULL:!MD5;                 # Use only strong ciphers

    # --- Security HTTP headers (recommended for all modern websites) ---
    add_header X-Frame-Options "SAMEORIGIN" always;           # Prevent clickjacking
    add_header X-Content-Type-Options "nosniff" always;        # Prevent MIME sniffing
    add_header X-XSS-Protection "1; mode=block" always;        # Enable XSS filter
    add_header Referrer-Policy "strict-origin-when-cross-origin" always; # Control information sent in Referer header
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always; # Force HTTPS

    # --- Root directory and index files ---
    root /var/www/wordpress;                                  # Web root for WordPress files
    index index.php index.html index.htm;                     # Order of index files

    # --- Main location: try static file, else fallback to index.php (WordPress) ---
    location / {
        try_files $uri $uri/ /index.php?$args;
    }

    # --- PHP-FPM handling (pass .php files to PHP service) ---
    location ~ \.php$ {
        include                 fastcgi_params;               # Include default FastCGI params
        fastcgi_pass            wordpress:9000;               # Pass to PHP-FPM (adapt service name/port if needed)
        fastcgi_index           index.php;
        fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    }

    # --- Deny access to hidden files (e.g., .htaccess, .env) ---
    location ~ /\. {
        deny all;
    }

    # --- Deny access to PHP files inside certain directories (extra security) ---
    location ~* /(?:uploads|files)/.*\.php$ {
        deny all;
    }

    # --- Limit upload file size (optional, adjust as needed) ---
    client_max_body_size 64M;
}